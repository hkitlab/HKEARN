                                                        </button>
                                                                    <p class="text-sm text-white/70 mt-1">${T('minWithdraw')}: ${minWithdrawal} ${T('pts')}</p>
                                                </div>
                                                    privacyPolicy: "এটি অ্যাডমিন দ্বারা সেট করা একটি প্লেসহোল্ডার পলিসি।",
                            <!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>HKEARN - আয় করুন</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans Bengali', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        /* একটিভ ন্যাভ লিঙ্কের জন্য স্টাইল */
        .nav-link.active {
            color: #4f46e5;
        }
        .nav-link.active .nav-icon {
            transform: scale(1.1);
        }
        /* টাস্কের জন্য কার্ড স্টাইল */
        .task-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .task-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* কাস্টম টোস্ট নোটিফিকেশন */
        #toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
        }
        #toast.show {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -10px);
        }
        #toast.success { background-color: #28a745; }
        #toast.error { background-color: #dc3545; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Global Loader -->
    <div id="global-loader" class="fixed inset-0 bg-white flex justify-center items-center z-50">
        <div class="loader"></div>
    </div>

    <!-- Toast Notification -->
    <div id="toast"></div>

    <!-- Login/Register Screen -->
    <div id="auth-screen" class="hidden">
        <div class="min-h-screen flex items-center justify-center bg-gray-50 px-4">
            <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
                <div id="login-view">
                    <h2 class="text-2xl font-bold text-center text-gray-800">HKEARN এ লগইন করুন</h2>
                    <form id="login-form" class="mt-6 space-y-6">
                        <input type="email" id="login-email" placeholder="আপনার ইমেইল" required class="w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <input type="password" id="login-password" placeholder="আপনার পাসওয়ার্ড" required class="w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <p id="login-error" class="text-sm text-red-600"></p>
                        <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700">লগইন</button>
                    </form>
                    <p class="mt-4 text-center text-sm">অ্যাকাউন্ট নেই? <a href="#" id="show-register" class="font-medium text-indigo-600 hover:text-indigo-500">রেজিস্টার করুন</a></p>
                </div>
                <div id="register-view" class="hidden">
                    <h2 class="text-2xl font-bold text-center text-gray-800">নতুন অ্যাকাউন্ট তৈরি করুন</h2>
                    <form id="register-form" class="mt-6 space-y-4">
                        <input type="text" id="register-name" placeholder="আপনার নাম" required class="w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm">
                        <input type="email" id="register-email" placeholder="আপনার ইমেইল" required class="w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm">
                        <input type="password" id="register-password" placeholder="নতুন পাসওয়ার্ড" required class="w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm">
                        <input type="text" id="register-referral" placeholder="রেফারেল কোড (ঐচ্ছিক)" class="w-full px-4 py-3 border border-gray-300 rounded-md shadow-sm">
                        <p id="register-error" class="text-sm text-red-600"></p>
                        <button type="submit" class="w-full px-4 py-3 font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700">রেজিস্টার</button>
                    </form>
                    <p class="mt-4 text-center text-sm"> ইতোমধ্যে অ্যাকাউন্ট আছে? <a href="#" id="show-login" class="font-medium text-indigo-600 hover:text-indigo-500">লগইন করুন</a></p>
                </div>
                 <div class="relative flex py-4 items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink mx-4 text-gray-400">অথবা</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>
                <button id="google-login" class="w-full flex items-center justify-center px-4 py-3 font-semibold text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                    <i class="fab fa-google mr-2"></i> গুগল দিয়ে ادامه দিন
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="app-screen" class="hidden">
        <main class="pb-20">
            <!-- Home Page -->
            <div id="home-page" class="page active p-4">
                <div class="bg-indigo-600 text-white p-6 rounded-xl shadow-lg mb-6">
                     <div class="flex justify-between items-center">
                        <div>
                            <p class="text-lg font-medium">মোট ব্যালেন্স</p>
                            <h2 class="text-4xl font-bold"><span id="user-balance">0</span> পয়েন্ট</h2>
                        </div>
                        <i class="fas fa-wallet fa-3x opacity-50"></i>
                    </div>
                </div>
                
                <h3 class="text-xl font-semibold text-gray-800 mb-4">আপনার জন্য টাস্ক</h3>
                <div id="home-tasks" class="grid grid-cols-2 gap-4">
                   <!-- Tasks will be loaded here -->
                   <a href="#" class="nav-link-btn" data-page="tasks">
                        <div class="bg-white p-4 rounded-lg shadow text-center">
                            <i class="fas fa-play-circle fa-2x text-red-500 mb-2"></i>
                            <p class="font-semibold">ভিডিও দেখুন</p>
                        </div>
                   </a>
                   <a href="#" class="nav-link-btn" data-page="tasks">
                        <div class="bg-white p-4 rounded-lg shadow text-center">
                            <i class="fas fa-globe fa-2x text-blue-500 mb-2"></i>
                            <p class="font-semibold">ওয়েবসাইট ভিজিট</p>
                        </div>
                   </a>
                     <a href="#" class="nav-link-btn" data-page="tasks">
                        <div class="bg-white p-4 rounded-lg shadow text-center">
                            <i class="fas fa-mouse-pointer fa-2x text-green-500 mb-2"></i>
                            <p class="font-semibold">অ্যাড ক্লিক</p>
                        </div>
                   </a>
                   <a href="#" class="nav-link-btn" data-page="profile">
                        <div class="bg-white p-4 rounded-lg shadow text-center">
                            <i class="fas fa-user-plus fa-2x text-purple-500 mb-2"></i>
                            <p class="font-semibold">রেফার করুন</p>
                        </div>
                   </a>
                </div>
            </div>

            <!-- Tasks Page -->
            <div id="tasks-page" class="page p-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">সব টাস্ক</h2>
                <div id="task-list" class="space-y-4">
                    <!-- Task items will be loaded here -->
                    <p>লোড হচ্ছে...</p>
                </div>
            </div>

            <!-- Withdraw Page -->
            <div id="withdraw-page" class="page p-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">টাকা তুলুন</h2>
                <div class="bg-white p-6 rounded-lg shadow-md">
                     <form id="withdraw-form" class="space-y-4">
                         <div>
                            <label class="block text-sm font-medium text-gray-700">কত টাকা তুলবেন?</label>
                            <input type="number" id="withdraw-amount" required placeholder="100" class="w-full mt-1 px-3 py-2 border rounded-md">
                            <p class="text-xs text-gray-500 mt-1">১০০০ পয়েন্ট = ১০ টাকা</p>
                         </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700">পেমেন্ট মাধ্যম</label>
                            <select id="withdraw-method" class="w-full mt-1 px-3 py-2 border rounded-md">
                                <option value="Bkash">বিকাশ</option>
                                <option value="Nagad">নগদ</option>
                                <option value="Bank">ব্যাংক</option>
                            </select>
                         </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700">অ্যাকাউন্ট নম্বর</label>
                            <input type="text" id="withdraw-account" required placeholder="আপনার অ্যাকাউন্ট নম্বর" class="w-full mt-1 px-3 py-2 border rounded-md">
                         </div>
                         <button type="submit" class="w-full px-4 py-2 font-semibold text-white bg-indigo-600 rounded-md hover:bg-indigo-700">রিকোয়েস্ট পাঠান</button>
                     </form>
                </div>
                <h3 class="text-xl font-semibold mt-6 mb-3">আপনার উইথড্রল হিস্ট্রি</h3>
                <div id="withdrawal-history" class="space-y-3"></div>
            </div>

            <!-- Profile Page -->
            <div id="profile-page" class="page p-4">
                <div class="flex items-center space-x-4 bg-white p-5 rounded-lg shadow mb-6">
                    <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-user fa-2x text-indigo-600"></i>
                    </div>
                    <div>
                        <h3 id="profile-name" class="text-xl font-bold">লোড হচ্ছে...</h3>
                        <p id="profile-email" class="text-gray-600">লোড হচ্ছে...</p>
                    </div>
                </div>

                 <div class="bg-white p-5 rounded-lg shadow mb-6">
                    <h4 class="font-semibold mb-2">আপনার রেফারেল কোড</h4>
                    <div class="flex items-center bg-gray-100 p-2 rounded-md">
                        <p id="referral-code" class="flex-grow font-mono text-lg">LOADING...</p>
                        <button id="copy-referral-btn" class="px-3 py-1 bg-indigo-500 text-white text-sm rounded-md">কপি</button>
                    </div>
                 </div>

                <div class="bg-white p-5 rounded-lg shadow">
                    <h4 class="font-semibold mb-3">লেনদেনের ইতিহাস</h4>
                    <div id="transaction-history" class="space-y-3 max-h-60 overflow-y-auto">
                        <!-- History will be here -->
                    </div>
                </div>

                <button id="logout-button" class="w-full mt-6 px-4 py-3 font-semibold text-white bg-red-600 rounded-md hover:bg-red-700">লগ আউট</button>
            </div>
        </main>
        
        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg flex justify-around">
            <a href="#" class="nav-link nav-link-btn active flex-1 text-center py-3" data-page="home">
                <i class="fas fa-home nav-icon"></i>
                <span class="block text-xs">হোম</span>
            </a>
            <a href="#" class="nav-link nav-link-btn flex-1 text-center py-3" data-page="tasks">
                <i class="fas fa-tasks nav-icon"></i>
                <span class="block text-xs">টাস্ক</span>
            </a>
            <a href="#" class="nav-link nav-link-btn flex-1 text-center py-3" data-page="withdraw">
                <i class="fas fa-hand-holding-usd nav-icon"></i>
                <span class="block text-xs">উইথড্র</span>
            </a>
            <a href="#" class="nav-link nav-link-btn flex-1 text-center py-3" data-page="profile">
                <i class="fas fa-user nav-icon"></i>
                <span class="block text-xs">প্রোফাইল</span>
            </a>
        </nav>
    </div>
    
    <!-- Task Completion Modal -->
    <div id="task-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-40 p-4">
        <div class="bg-white rounded-lg w-full max-w-lg p-6">
            <h3 id="task-modal-title" class="text-xl font-bold mb-4"></h3>
            <div id="task-modal-content"></div>
            <div id="task-timer" class="text-center text-2xl font-bold my-4 text-indigo-600"></div>
            <button id="claim-reward-btn" disabled class="w-full mt-4 px-4 py-3 font-semibold text-white bg-green-500 rounded-md disabled:bg-gray-400 disabled:cursor-not-allowed">
                রিওয়ার্ড সংগ্রহ করুন
            </button>
             <button id="close-task-modal" class="w-full mt-2 px-4 py-2 font-semibold text-gray-700 bg-gray-200 rounded-md">বন্ধ করুন</button>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, writeBatch, query, where, orderBy, addDoc, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- আপনার Firebase প্রজেক্টের কনফিগারেশন এখানে যোগ করুন ---
        const firebaseConfig = {
            apiKey: "AIzaSyC_KJiMcn_UKslB-Y_Mpxq2XA6h-zxXygg",
  authDomain: "hk-cash-316af.firebaseapp.com",
  projectId: "hk-cash-316af",
  storageBucket: "hk-cash-316af.firebasestorage.app",
  messagingSenderId: "1012157922332",
  appId: "1:1012157922332:web:b5485afd760901645ff3d9",
};


        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const globalLoader = document.getElementById('global-loader');
        const authScreen = document.getElementById('auth-screen');
        const appScreen = document.getElementById('app-screen');
        const loginView = document.getElementById('login-view');
        const registerView = document.getElementById('register-view');

        let currentUser = null;
        let userData = null;

        // Toast Notification Function
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = ``; // Reset classes
            toast.classList.add(type, 'show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async user => {
            if (user) {
                currentUser = user;
                await loadUserData();
                authScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                navigateTo('home');
            } else {
                currentUser = null;
                userData = null;
                authScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
            }
            globalLoader.classList.add('hidden');
        });
        
        // Form switching
        document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); loginView.classList.add('hidden'); registerView.classList.remove('hidden'); });
        document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); registerView.classList.add('hidden'); loginView.classList.remove('hidden'); });

        // Register
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const referralCode = document.getElementById('register-referral').value.trim();
            const errorP = document.getElementById('register-error');
            errorP.textContent = '';

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Create user profile in Firestore
                const userRef = doc(db, "users", user.uid);
                const newUser = {
                    name: name,
                    email: user.email,
                    walletBalance: 0,
                    referralCode: Math.random().toString(36).substring(2, 8).toUpperCase(),
                    createdAt: serverTimestamp()
                };

                // Handle referral
                let bonus = 0;
                if(referralCode) {
                    const q = query(collection(db, "users"), where("referralCode", "==", referralCode));
                    const querySnapshot = await getDocs(q);
                    if (!querySnapshot.empty) {
                        const referrerDoc = querySnapshot.docs[0];
                        newUser.referredBy = referrerDoc.id;
                        bonus = 50; // Referral bonus points
                        newUser.walletBalance += bonus;

                        // Give bonus to referrer
                        const referrerRef = doc(db, "users", referrerDoc.id);
                        const referrerData = referrerDoc.data();
                        await setDoc(referrerRef, { walletBalance: (referrerData.walletBalance || 0) + 100 }, { merge: true });
                    } else {
                         showToast("ভুল রেফারেল কোড।", "error");
                    }
                }
                
                await setDoc(userRef, newUser);

                if (bonus > 0) {
                     const transactionRef = collection(db, "transactions");
                     await addDoc(transactionRef, { userId: user.uid, type: 'bonus', amount: bonus, description: 'রেফারেল বোনাস', timestamp: serverTimestamp() });
                }

            } catch (error) {
                errorP.textContent = "রেজিস্ট্রেশন ব্যর্থ: " + error.message;
            }
        });
        
        // Login
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorP = document.getElementById('login-error');
            errorP.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorP.textContent = "লগইন ব্যর্থ। ইমেল বা পাসওয়ার্ড ভুল।";
            }
        });
        
        // Google Login
        document.getElementById('google-login').addEventListener('click', async () => {
             const provider = new GoogleAuthProvider();
             try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                // Check if user exists in Firestore, if not create a profile
                const userRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userRef);
                if (!docSnap.exists()) {
                    await setDoc(userRef, {
                        name: user.displayName,
                        email: user.email,
                        walletBalance: 0,
                        referralCode: Math.random().toString(36).substring(2, 8).toUpperCase(),
                        createdAt: serverTimestamp()
                    });
                }
             } catch (error) {
                console.error("Google login failed", error);
                showToast("গুগল লগইন ব্যর্থ হয়েছে।", "error");
             }
        });

        // Logout
        document.getElementById('logout-button').addEventListener('click', () => {
            signOut(auth);
        });

        // --- DATA LOADING & UI UPDATE ---
        async function loadUserData() {
            if (!currentUser) return;
            const userRef = doc(db, "users", currentUser.uid);
            const docSnap = await getDoc(userRef);
            if (docSnap.exists()) {
                userData = docSnap.data();
                updateUI();
            } else {
                console.error("User data not found in Firestore!");
            }
        }

        function updateUI() {
            if (!userData) return;
            document.getElementById('user-balance').textContent = userData.walletBalance || 0;
            document.getElementById('profile-name').textContent = userData.name;
            document.getElementById('profile-email').textContent = userData.email;
            document.getElementById('referral-code').textContent = userData.referralCode;
        }

        // --- NAVIGATION ---
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-link');
        
        function navigateTo(pageId) {
            pages.forEach(p => p.classList.remove('active'));
            document.getElementById(`${pageId}-page`).classList.add('active');
            
            navLinks.forEach(l => l.classList.remove('active'));
            document.querySelector(`.nav-link[data-page="${pageId}"]`).classList.add('active');
            
            // Load data for the specific page
            if (pageId === 'tasks') loadTasks();
            if (pageId === 'profile') loadTransactionHistory();
            if (pageId === 'withdraw') loadWithdrawalHistory();
        }

        document.querySelectorAll('.nav-link-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                navigateTo(btn.dataset.page);
            });
        });

        // --- TASKS ---
        async function loadTasks() {
            const taskList = document.getElementById('task-list');
            taskList.innerHTML = '<div class="flex justify-center"><div class="loader"></div></div>';
            const tasksRef = collection(db, "tasks");
            const q = query(tasksRef, where("isActive", "==", true));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                taskList.innerHTML = '<p class="text-center text-gray-500">এখন কোনো টাস্ক নেই।</p>';
                return;
            }

            let taskHTML = '';
            snapshot.forEach(doc => {
                const task = doc.data();
                const icons = {
                    watchVideo: 'fa-play-circle text-red-500',
                    visitWebsite: 'fa-globe text-blue-500',
                    clickAd: 'fa-mouse-pointer text-green-500'
                };
                taskHTML += `
                <div class="task-card bg-white p-4 rounded-lg shadow flex items-center space-x-4">
                    <i class="fas ${icons[task.type] || 'fa-tasks'} fa-2x w-10 text-center"></i>
                    <div class="flex-grow">
                        <h4 class="font-bold text-gray-800">${task.title}</h4>
                        <p class="text-sm text-gray-500">${task.reward} পয়েন্ট আয় করুন</p>
                    </div>
                    <button class="start-task-btn px-4 py-2 bg-indigo-500 text-white text-sm rounded-md font-semibold" data-id="${doc.id}">শুরু করুন</button>
                </div>
                `;
            });
            taskList.innerHTML = taskHTML;
            attachTaskListeners();
        }

        function attachTaskListeners() {
            document.querySelectorAll('.start-task-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const taskId = e.target.dataset.id;
                    const taskRef = doc(db, "tasks", taskId);
                    const taskSnap = await getDoc(taskRef);
                    if (taskSnap.exists()) {
                        openTaskModal(taskSnap.data(), taskId);
                    }
                });
            });
        }
        
        // Task Modal Logic
        const taskModal = document.getElementById('task-modal');
        let timerInterval;

        function openTaskModal(task, taskId) {
            const titleEl = document.getElementById('task-modal-title');
            const contentEl = document.getElementById('task-modal-content');
            const timerEl = document.getElementById('task-timer');
            const claimBtn = document.getElementById('claim-reward-btn');

            titleEl.textContent = task.title;
            claimBtn.disabled = true;
            
            if (task.type === 'visitWebsite' || task.type === 'clickAd') {
                contentEl.innerHTML = `<p class="text-center">আপনাকে একটি নতুন ট্যাবে পাঠানো হচ্ছে। <br> নির্দিষ্ট সময় অপেক্ষা করার পর ফিরে এসে রিওয়ার্ড সংগ্রহ করুন।</p>`;
                window.open(task.url, '_blank');
            } else if (task.type === 'watchVideo') {
                contentEl.innerHTML = `<p class="text-center">ভিডিওটি দেখুন এবং সময় শেষ হলে রিওয়ার্ড সংগ্রহ করুন।</p><p class="text-sm text-red-500 text-center">(বাস্তব অ্যাপে এখানে ভিডিও প্লেয়ার থাকবে)</p>`;
            }

            taskModal.classList.remove('hidden');
            
            let timeLeft = task.duration;
            timerEl.textContent = `${timeLeft} সেকেন্ড`;
            
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = `${timeLeft} সেকেন্ড`;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    timerEl.textContent = "সময় শেষ!";
                    claimBtn.disabled = false;
                }
            }, 1000);
            
            claimBtn.onclick = () => claimReward(task, taskId);
        }
        
        document.getElementById('close-task-modal').addEventListener('click', () => {
            clearInterval(timerInterval);
            taskModal.classList.add('hidden');
        });
        
        async function claimReward(task, taskId) {
            clearInterval(timerInterval);
            taskModal.classList.add('hidden');
            
            const batch = writeBatch(db);

            // 1. Update user balance
            const userRef = doc(db, "users", currentUser.uid);
            const newBalance = (userData.walletBalance || 0) + task.reward;
            batch.update(userRef, { walletBalance: newBalance });

            // 2. Add to transaction history
            const transRef = doc(collection(db, "transactions"));
            batch.set(transRef, {
                userId: currentUser.uid,
                type: 'credit',
                amount: task.reward,
                description: `টাস্ক সম্পন্ন: ${task.title}`,
                timestamp: serverTimestamp()
            });
            
            await batch.commit();

            showToast(`${task.reward} পয়েন্ট যোগ হয়েছে!`, 'success');
            await loadUserData(); // Refresh user data and UI
        }
        
        // --- WITHDRAW ---
        document.getElementById('withdraw-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const amount = parseInt(document.getElementById('withdraw-amount').value);
            const method = document.getElementById('withdraw-method').value;
            const account = document.getElementById('withdraw-account').value;
            
            const pointsToDeduct = amount * 100; // 10 BDT = 1000 points

            if (pointsToDeduct > userData.walletBalance) {
                showToast("আপনার পর্যাপ্ত ব্যালেন্স নেই!", "error");
                return;
            }

            const batch = writeBatch(db);
            // 1. Deduct points from user
            const userRef = doc(db, "users", currentUser.uid);
            const newBalance = userData.walletBalance - pointsToDeduct;
            batch.update(userRef, { walletBalance: newBalance });

            // 2. Create withdrawal request
            const withdrawalRef = doc(collection(db, "withdrawals"));
            batch.set(withdrawalRef, {
                userId: currentUser.uid,
                userName: userData.name,
                amount: amount,
                method: method,
                accountInfo: account,
                status: 'pending',
                requestedAt: serverTimestamp()
            });
            
            // 3. Log transaction
            const transRef = doc(collection(db, "transactions"));
            batch.set(transRef, {
                userId: currentUser.uid,
                type: 'debit',
                amount: -pointsToDeduct,
                description: `উইথড্রল রিকোয়েস্ট`,
                timestamp: serverTimestamp()
            });

            await batch.commit();

            showToast("আপনার উইথড্রল রিকোয়েস্ট সফলভাবে পাঠানো হয়েছে।");
            e.target.reset();
            await loadUserData();
            loadWithdrawalHistory();
        });

        async function loadWithdrawalHistory() {
             const historyDiv = document.getElementById('withdrawal-history');
             historyDiv.innerHTML = '<p>লোড হচ্ছে...</p>';
             const q = query(collection(db, "withdrawals"), where("userId", "==", currentUser.uid), orderBy("requestedAt", "desc"));
             const snapshot = await getDocs(q);

             if (snapshot.empty) {
                 historyDiv.innerHTML = '<p class="text-center text-gray-500">কোনো হিস্ট্রি নেই।</p>';
                 return;
             }
             
             let html = '';
             snapshot.forEach(doc => {
                 const req = doc.data();
                 const statusColors = { pending: 'text-yellow-500', approved: 'text-green-500', rejected: 'text-red-500' };
                 html += `
                    <div class="bg-gray-50 p-3 rounded-md flex justify-between items-center">
                        <div>
                            <p class="font-semibold">${req.amount} টাকা - ${req.method}</p>
                            <p class="text-xs text-gray-500">${new Date(req.requestedAt.seconds * 1000).toLocaleString('bn-BD')}</p>
                        </div>
                        <p class="font-bold ${statusColors[req.status]}">${req.status.toUpperCase()}</p>
                    </div>
                 `;
             });
             historyDiv.innerHTML = html;
        }

        // --- PROFILE & HISTORY ---
        document.getElementById('copy-referral-btn').addEventListener('click', () => {
            const code = document.getElementById('referral-code').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showToast('রেফারেল কোড কপি করা হয়েছে!', 'success');
            });
        });

        async function loadTransactionHistory() {
            const historyDiv = document.getElementById('transaction-history');
            historyDiv.innerHTML = '<p>লোড হচ্ছে...</p>';
            const q = query(collection(db, "transactions"), where("userId", "==", currentUser.uid), orderBy("timestamp", "desc"), limit(20));
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                 historyDiv.innerHTML = '<p class="text-center text-gray-500">কোনো লেনদেন নেই।</p>';
                 return;
             }

            let html = '';
            snapshot.forEach(doc => {
                const trans = doc.data();
                const isCredit = trans.type === 'credit' || trans.type === 'bonus';
                html += `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-medium">${trans.description}</p>
                            <p class="text-xs text-gray-500">${new Date(trans.timestamp.seconds * 1000).toLocaleDateString('bn-BD')}</p>
                        </div>
                        <p class="font-bold ${isCredit ? 'text-green-600' : 'text-red-600'}">${isCredit ? '+' : ''}${trans.amount}</p>
                    </div>
                `;
            });
            historyDiv.innerHTML = html;
        }

    </script>
</body>
    </html>
