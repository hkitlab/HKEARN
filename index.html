<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>মনিটাইজেশন প্যানেল</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter (for modern look) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Dark background */
            color: #c9d1d9; /* Light text */
        }
        .card {
            background-color: #161b22;
            border: 1px solid #30363d;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .btn-primary {
            background-color: #238636; /* GitHub green */
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2ea043;
        }
        .input-field {
            background-color: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div id="loading-screen" class="fixed inset-0 flex items-center justify-center bg-[#0d1117] z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-500 mx-auto"></div>
            <p class="mt-4 text-lg">লোড হচ্ছে... (Initializing)</p>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="hidden max-w-7xl mx-auto">
        
        <!-- Header & Navigation -->
        <header class="flex justify-between items-center pb-6 border-b border-gray-700 mb-8">
            <h1 class="text-3xl font-bold text-green-400">মনিটাইজেশন ড্যাশবোর্ড</h1>
            <button id="logout-btn" class="hidden btn-primary px-4 py-2 rounded-lg text-sm font-semibold">
                লগআউট
            </button>
        </header>

        <!-- Login/Register View -->
        <section id="auth-view" class="max-w-md mx-auto card p-6">
            <h2 class="text-xl font-semibold mb-6" id="auth-title">লগইন</h2>
            <input type="email" id="email" placeholder="ইমেল" class="input-field w-full p-3 mb-4 rounded-lg">
            <input type="password" id="password" placeholder="পাসওয়ার্ড" class="input-field w-full p-3 mb-6 rounded-lg">
            <button id="auth-action-btn" class="btn-primary w-full p-3 font-bold rounded-lg mb-4">লগইন করুন</button>
            <p id="auth-toggle" class="text-center text-sm cursor-pointer text-gray-400 hover:text-green-400">
                অ্যাকাউন্ট নেই? <span class="font-bold">রেজিস্টার করুন</span>
            </p>
            <p id="auth-message" class="text-center text-red-400 mt-3"></p>
        </section>

        <!-- Dynamic Dashboard View (User/Admin) -->
        <section id="dashboard-view" class="hidden">
            <!-- User/Admin content will be injected here -->
        </section>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestore লগের জন্য (ডিবাগিং-এর সময় সহায়ক)
        setLogLevel('Debug');

        // গ্লোবাল ভেরিয়েবল সেটআপ
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db, userId = null;
        let isRegisterMode = false;

        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const appContainer = document.getElementById('app-container');
        const authView = document.getElementById('auth-view');
        const dashboardView = document.getElementById('dashboard-view');
        const logoutBtn = document.getElementById('logout-btn');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authActionBtn = document.getElementById('auth-action-btn');
        const authToggle = document.getElementById('auth-toggle');
        const authTitle = document.getElementById('auth-title');
        const authMessage = document.getElementById('auth-message');

        // --- Firebase Initialization and Authentication Logic ---

        try {
            // ১. Firebase অ্যাপ ইনিশিয়ালাইজ করুন
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // ২. ইনিশিয়াল অথ টোকেন ব্যবহার করে সাইন ইন করুন
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken)
                    .catch(error => {
                        console.error("Custom token sign-in failed. Falling back to anonymous:", error);
                        signInAnonymously(auth);
                    });
            } else {
                signInAnonymously(auth);
            }

            // ৩. Auth State Listener
            onAuthStateChanged(auth, async (user) => {
                loadingScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');

                if (user) {
                    userId = user.uid;
                    authView.classList.add('hidden');
                    dashboardView.classList.remove('hidden');
                    logoutBtn.classList.remove('hidden');

                    // Firestore থেকে ব্যবহারকারীর রোল এবং ব্যালেন্স আনুন
                    const userDocRef = doc(db, "artifacts", appId, "users", userId, "profile", "info");
                    const userDoc = await getDoc(userDocRef);
                    
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        
                        if (userData.role === 'admin') {
                            renderAdminDashboard(userData);
                        } else {
                            renderUserDashboard(userData);
                        }
                    } else {
                        // যদি প্রোফাইল ডেটা না থাকে, তবে লগআউট করুন এবং সাইন-ইন স্ক্রিন দেখান।
                        console.log("Profile data missing, rendering auth view.");
                        signOut(auth);
                    }
                } else {
                    // লগইন বা রেজিস্ট্রেশন ভিউ দেখান
                    userId = null;
                    authView.classList.remove('hidden');
                    dashboardView.classList.add('hidden');
                    logoutBtn.classList.add('hidden');
                }
            });

        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.getElementById('loading-screen').innerHTML = `<p class="text-red-500">Firebase ইনিশিয়ালাইজেশন ব্যর্থ: ${error.message}</p>`;
        }
        
        // --- UI Event Handlers ---

        authToggle.addEventListener('click', () => {
            isRegisterMode = !isRegisterMode;
            authTitle.textContent = isRegisterMode ? 'রেজিস্টার' : 'লগইন';
            authActionBtn.textContent = isRegisterMode ? 'রেজিস্টার করুন' : 'লগইন করুন';
            authToggle.innerHTML = isRegisterMode ? 'ইতিমধ্যে অ্যাকাউন্ট আছে? <span class="font-bold">লগইন করুন</span>' : 'অ্যাকাউন্ট নেই? <span class="font-bold">রেজিস্টার করুন</span>';
            authMessage.textContent = '';
        });

        authActionBtn.addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            authMessage.textContent = '';

            if (isRegisterMode) {
                handleRegister(email, password);
            } else {
                handleLogin(email, password);
            }
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        // --- Authentication Functions ---

        async function handleLogin(email, password) {
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                authMessage.textContent = `লগইন ব্যর্থ: ${error.message.replace('Firebase: Error (auth/', '').replace(/\)\./g, '')}`;
            }
        }

        async function handleRegister(email, password) {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // Firestore-এ সাধারণ ব্যবহারকারী হিসেবে ডেটা সংরক্ষণ
                const userDocRef = doc(db, "artifacts", appId, "users", user.uid, "profile", "info");
                await setDoc(userDocRef, {
                    email: email,
                    role: 'user', // ডিফল্ট রোল 'user'
                    balance: 0.00,
                    name: 'নতুন ব্যবহারকারী',
                    createdAt: new Date().toISOString()
                });
            } catch (error) {
                authMessage.textContent = `রেজিস্ট্রেশন ব্যর্থ: ${error.message.replace('Firebase: Error (auth/', '').replace(/\)\./g, '')}`;
            }
        }

        // --- Dashboard Rendering Functions ---

        function renderUserDashboard(userData) {
            const userHtml = `
                <div class="space-y-8">
                    <h2 class="text-2xl font-semibold text-green-300 border-b border-gray-700 pb-3">ব্যবহারকারী ড্যাশবোর্ড</h2>
                    <p class="text-sm text-gray-400">আপনার ইউজার আইডি (অন্যদের সাথে শেয়ার করার জন্য): <span class="font-mono text-green-400 break-all">${userId}</span></p>

                    <!-- ব্যালেন্স কার্ড -->
                    <div class="card p-6">
                        <h3 class="text-xl font-medium mb-2">বর্তমান ব্যালেন্স</h3>
                        <p id="user-balance" class="text-4xl font-bold text-yellow-400">$${userData.balance.toFixed(2)}</p>
                        <button class="btn-primary mt-4 px-4 py-2 rounded-lg">পেমেন্টের অনুরোধ করুন</button>
                    </div>

                    <!-- ওয়েবসাইট যোগ করার ফর্ম -->
                    <div class="card p-6">
                        <h3 class="text-xl font-medium mb-4">নতুন ওয়েবসাইট যোগ করুন</h3>
                        <input type="url" id="new-site-url" placeholder="ওয়েবসাইটের URL (যেমন: https://example.com)" class="input-field w-full p-3 mb-4 rounded-lg">
                        <button id="add-site-btn" class="btn-primary w-full p-3 font-bold rounded-lg">পর্যালোচনার জন্য জমা দিন</button>
                    </div>

                    <!-- সক্রিয় ওয়েবসাইট তালিকা -->
                    <div class="card p-6">
                        <h3 class="text-xl font-medium mb-4">আপনার ওয়েবসাইটসমূহ</h3>
                        <div id="user-sites-list" class="space-y-4">
                            <!-- সাইট তালিকা এখানে লোড হবে -->
                            <p class="text-gray-500">ওয়েবসাইট ডেটা লোড হচ্ছে...</p>
                        </div>
                    </div>
                </div>
            `;
            dashboardView.innerHTML = userHtml;

            // ইভেন্ট লিসেনার সেটআপ
            document.getElementById('add-site-btn').addEventListener('click', handleAddSite);
            
            // রিয়েল-টাইম ডেটা লোড
            listenToUserBalance(userId);
            listenToUserWebsites(userId);
        }

        function renderAdminDashboard(userData) {
            const adminHtml = `
                <div class="space-y-8">
                    <h2 class="text-2xl font-semibold text-red-400 border-b border-gray-700 pb-3">অ্যাডমিন কন্ট্রোল প্যানেল</h2>
                    <p class="text-sm text-gray-400">অ্যাডমিন আইডি: <span class="font-mono text-green-400 break-all">${userId}</span></p>

                    <!-- সিস্টেম স্ট্যাটাস -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="card p-6">
                            <h3 class="text-lg font-medium">মোট ইউজার</h3>
                            <p id="total-users" class="text-3xl font-bold text-blue-400">...</p>
                        </div>
                        <div class="card p-6">
                            <h3 class="text-lg font-medium">পর্যালোচনাধীন সাইট</h3>
                            <p id="pending-sites-count" class="text-3xl font-bold text-yellow-400">...</p>
                        </div>
                        <div class="card p-6">
                            <h3 class="text-lg font-medium">মোট আয় (সিস্টেম)</h3>
                            <p class="text-3xl font-bold text-green-400">$0.00</p>
                        </div>
                    </div>

                    <!-- অপেক্ষমান ওয়েবসাইট পর্যালোচনা -->
                    <div class="card p-6">
                        <h3 class="text-xl font-medium mb-4">অপেক্ষমান ওয়েবসাইটসমূহ (Review Queue)</h3>
                        <div id="pending-sites-list" class="space-y-4">
                            <!-- অপেক্ষমান সাইট তালিকা এখানে লোড হবে -->
                            <p class="text-gray-500">অপেক্ষমান ডেটা লোড হচ্ছে...</p>
                        </div>
                    </div>
                    
                    <!-- সকল ব্যবহারকারী -->
                    <div class="card p-6">
                        <h3 class="text-xl font-medium mb-4">সকল প্ল্যাটফর্ম ব্যবহারকারী</h3>
                        <div id="all-users-list" class="space-y-4">
                            <p class="text-gray-500">ব্যবহারকারীর ডেটা লোড হচ্ছে...</p>
                        </div>
                    </div>
                </div>
            `;
            dashboardView.innerHTML = adminHtml;
            
            // রিয়েল-টাইম ডেটা লোড
            listenToAllUsers();
            listenToPendingWebsites();
        }

        // --- User Logic Functions ---

        async function handleAddSite() {
            const url = document.getElementById('new-site-url').value.trim();
            if (!url) return alert('দয়া করে একটি সঠিক URL দিন।');

            const user = auth.currentUser;
            if (!user) return alert('অনুগ্রহ করে পুনরায় লগইন করুন।');

            try {
                const websitesColRef = collection(db, "artifacts", appId, "public", "data", "websites");
                await addDoc(websitesColRef, {
                    userId: user.uid,
                    url: url,
                    status: 'pending', // পর্যালোচনার জন্য অপেক্ষমান
                    monetizationCode: `AD-${Date.now()}-${user.uid.substring(0, 4)}`, // ইউনিক কোড
                    currentEarnings: 0.00,
                    submittedAt: new Date().toISOString()
                });
                document.getElementById('new-site-url').value = '';
                // কাস্টম মেসেজ বক্স ব্যবহার করা উচিত, তবে এখানে alert ব্যবহার করা হলো নির্দেশ অনুসারে
                alert('ওয়েবসাইটটি সফলভাবে পর্যালোচনার জন্য জমা দেওয়া হয়েছে। অ্যাডমিন অনুমোদন দিলে এটি সক্রিয় হবে।');
            } catch (error) {
                console.error("Error submitting site:", error);
                alert('ওয়েবসাইট জমা দিতে ব্যর্থ: ' + error.message);
            }
        }

        // --- Firestore Listeners (Real-time Data) ---

        function listenToUserBalance(uid) {
            const profileDocRef = doc(db, "artifacts", appId, "users", uid, "profile", "info");
            
            onSnapshot(profileDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const balance = docSnap.data().balance || 0.00;
                    const balanceEl = document.getElementById('user-balance');
                    if (balanceEl) {
                        balanceEl.textContent = `$${balance.toFixed(2)}`;
                    }
                }
            }, (error) => {
                console.error("Error fetching balance:", error);
            });
        }
        
        function listenToUserWebsites(uid) {
            const websitesColRef = collection(db, "artifacts", appId, "public", "data", "websites");
            const q = query(websitesColRef, where("userId", "==", uid));
            const listEl = document.getElementById('user-sites-list');

            onSnapshot(q, (snapshot) => {
                if (!listEl) return;
                listEl.innerHTML = '';
                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-gray-500">আপনার কোনো ওয়েবসাইট যুক্ত করা নেই।</p>';
                    return;
                }

                snapshot.docs.forEach(doc => {
                    const site = doc.data();
                    const statusClass = site.status === 'active' ? 'text-green-500' : (site.status === 'pending' ? 'text-yellow-500' : 'text-red-500');
                    
                    listEl.innerHTML += `
                        <div class="p-4 card flex justify-between items-center">
                            <div>
                                <p class="text-lg font-semibold">${site.url}</p>
                                <p class="text-sm ${statusClass}">স্ট্যাটাস: ${site.status.toUpperCase()}</p>
                                <p class="text-sm text-gray-400 mt-1">আয়: <span class="text-yellow-300 font-bold">$${site.currentEarnings.toFixed(2)}</span></p>
                            </div>
                            ${site.status === 'active' ? 
                                `<button onclick="copyCode('${site.monetizationCode}')" class="btn-primary text-xs px-3 py-1">কোড কপি করুন</button>` 
                                : ''}
                        </div>
                    `;
                });
            }, (error) => {
                if (listEl) listEl.innerHTML = `<p class="text-red-400">ওয়েবসাইট লোড করতে ব্যর্থ: ${error.message}</p>`;
                console.error("Error fetching user sites:", error);
            });
        }
        
        // গ্লোবাল ফাংশন যা কপি করতে পারবে (ইনলাইন ইভেন্টের জন্য)
        window.copyCode = function(code) {
            const tempInput = document.createElement("textarea");
            tempInput.value = code;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            alert(`মনিটাইজেশন কোড কপি করা হয়েছে: ${code}`); // কাস্টম মেসেজ বক্স ব্যবহার করা উচিত
        }

        // --- Admin Logic Functions and Listeners ---
        
        function listenToAllUsers() {
            const usersColRef = collection(db, "artifacts", appId, "users");
            const listEl = document.getElementById('all-users-list');

            // 'profile' সাব-কালেকশন থেকে ডেটা আনার জন্য একটি বিশেষ কোয়েরি
            // Firebase-এ এটি সরাসরি করা কঠিন, তাই আমরা শুধু ডকুমেন্ট আইডিগুলি দেখাব
            // অথবা একটি ডামি 'profile' কালেকশন থেকে টানব। এখানে আমরা একটি সিমুলেটেড লিস্ট দেখাব।
            // সঠিক বাস্তবায়নের জন্য Cloud Functions বা কমপ্লেক্স Firestore নিয়ম দরকার।
            // সরলতার জন্য, আমরা শুধুমাত্র ডিরেক্টরি ডকুমেন্টগুলি দেখব (যদি থাকে)।

            onSnapshot(usersColRef, (snapshot) => {
                 if (!listEl) return;
                listEl.innerHTML = '';
                let totalUsers = 0;

                snapshot.docs.forEach(async (docSnap) => {
                    // প্রতিটি ইউজার ডকুমেন্ট এর ভেতরের প্রোফাইল info ডকুমেন্ট লোড করুন
                    const profileDocRef = doc(db, "artifacts", appId, "users", docSnap.id, "profile", "info");
                    const profileDoc = await getDoc(profileDocRef);

                    if (profileDoc.exists()) {
                        const userData = profileDoc.data();
                        totalUsers++;
                        
                        listEl.innerHTML += `
                            <div class="p-4 card flex justify-between items-center text-sm">
                                <div>
                                    <p class="font-semibold">${userData.email} (${userData.role.toUpperCase()})</p>
                                    <p class="text-gray-500">ID: ${docSnap.id}</p>
                                </div>
                                <p class="font-bold text-yellow-300">Balance: $${userData.balance.toFixed(2)}</p>
                            </div>
                        `;
                    }
                });
                
                document.getElementById('total-users').textContent = totalUsers;

            }, (error) => {
                if (listEl) listEl.innerHTML = `<p class="text-red-400">ব্যবহারকারী লোড করতে ব্যর্থ: ${error.message}</p>`;
                console.error("Error fetching all users:", error);
            });
        }


        function listenToPendingWebsites() {
            const websitesColRef = collection(db, "artifacts", appId, "public", "data", "websites");
            const q = query(websitesColRef, where("status", "==", "pending"));
            const listEl = document.getElementById('pending-sites-list');

            onSnapshot(q, (snapshot) => {
                if (!listEl) return;
                listEl.innerHTML = '';
                document.getElementById('pending-sites-count').textContent = snapshot.size;

                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-gray-500">পর্যালোচনার জন্য কোনো ওয়েবসাইট নেই।</p>';
                    return;
                }

                snapshot.docs.forEach(doc => {
                    const site = doc.data();
                    
                    listEl.innerHTML += `
                        <div class="p-4 card">
                            <p class="text-lg font-semibold text-yellow-300">${site.url}</p>
                            <p class="text-sm text-gray-400">ব্যবহারকারী ID: ${site.userId}</p>
                            <div class="mt-3 space-x-3">
                                <button onclick="handleApproval('${doc.id}', 'active')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-lg text-sm">অনুমোদন (Approve)</button>
                                <button onclick="handleApproval('${doc.id}', 'rejected')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-sm">বাতিল (Reject)</button>
                            </div>
                        </div>
                    `;
                });
            }, (error) => {
                if (listEl) listEl.innerHTML = `<p class="text-red-400">অপেক্ষমান সাইট লোড করতে ব্যর্থ: ${error.message}</p>`;
                console.error("Error fetching pending sites:", error);
            });
        }
        
        // গ্লোবাল ফাংশন: অ্যাডমিন দ্বারা সাইট অনুমোদন/বাতিল
        window.handleApproval = async function(siteId, newStatus) {
            if (!confirm(`আপনি কি নিশ্চিত যে আপনি এই সাইটটি "${newStatus.toUpperCase()}" করতে চান?`)) {
                return;
            }
            try {
                const docRef = doc(db, "artifacts", appId, "public", "data", "websites", siteId);
                await setDoc(docRef, { status: newStatus }, { merge: true });
                alert(`সাইটটি সফলভাবে "${newStatus.toUpperCase()}" করা হয়েছে।`);
            } catch (error) {
                console.error("Approval/Rejection failed:", error);
                alert('স্ট্যাটাস আপডেট করতে ব্যর্থ: ' + error.message);
            }
        }

    </script>
</body>
</html>


